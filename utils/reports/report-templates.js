/**
 * Basset Hound Browser Automation - Report Templates
 * Phase 18.2: Export/Import and Report Generation
 *
 * Pre-built and customizable report templates:
 * - Investigation Report
 * - Executive Briefing
 * - Technical Analysis
 * - Evidence Documentation
 * - Template editor and management
 * - Custom sections and fields
 * - Conditional sections
 *
 * @module report-templates
 */

// =============================================================================
// Template Definitions
// =============================================================================

/**
 * Investigation Report Template
 */
const InvestigationReportTemplate = {
  id: 'investigation-report',
  name: 'Investigation Report',
  description: 'Comprehensive investigation report with all sections',
  version: '1.0.0',
  category: 'investigation',

  sections: [
    {
      id: 'coverPage',
      name: 'Cover Page',
      required: true,
      conditional: false,
      fields: [
        { name: 'title', label: 'Report Title', type: 'text', required: true },
        { name: 'caseNumber', label: 'Case Number', type: 'text', required: true },
        { name: 'classification', label: 'Classification', type: 'select', options: ['Unclassified', 'Confidential', 'Secret'] },
        { name: 'generatedDate', label: 'Generated Date', type: 'date', required: true },
        { name: 'generatedBy', label: 'Generated By', type: 'text', required: true }
      ]
    },
    {
      id: 'tableOfContents',
      name: 'Table of Contents',
      required: true,
      conditional: false,
      autoGenerate: true
    },
    {
      id: 'executiveSummary',
      name: 'Executive Summary',
      required: true,
      conditional: false,
      fields: [
        { name: 'overview', label: 'Overview', type: 'textarea', required: true },
        { name: 'scope', label: 'Scope', type: 'textarea' },
        { name: 'keyFindings', label: 'Key Findings', type: 'list' }
      ]
    },
    {
      id: 'caseOverview',
      name: 'Case Overview',
      required: true,
      conditional: false,
      fields: [
        { name: 'caseId', label: 'Case ID', type: 'text', dataSource: 'case.caseId' },
        { name: 'title', label: 'Title', type: 'text', dataSource: 'case.title' },
        { name: 'status', label: 'Status', type: 'text', dataSource: 'case.status' },
        { name: 'investigator', label: 'Investigator', type: 'text', dataSource: 'case.investigator' },
        { name: 'createdAt', label: 'Created', type: 'date', dataSource: 'case.createdAt' }
      ]
    },
    {
      id: 'methodology',
      name: 'Methodology',
      required: false,
      conditional: false,
      fields: [
        { name: 'tools', label: 'Tools and Techniques', type: 'textarea' },
        { name: 'procedures', label: 'Procedures', type: 'textarea' },
        { name: 'standards', label: 'Standards Followed', type: 'list' }
      ]
    },
    {
      id: 'findings',
      name: 'Findings',
      required: true,
      conditional: true,
      conditionDataSource: 'statistics.totalEvidence',
      conditionOperator: '>',
      conditionValue: 0,
      fields: [
        { name: 'findings', label: 'Findings', type: 'list', dataSource: 'findings' }
      ]
    },
    {
      id: 'evidenceSummary',
      name: 'Evidence Summary',
      required: true,
      conditional: true,
      conditionDataSource: 'statistics.totalEvidence',
      conditionOperator: '>',
      conditionValue: 0,
      fields: [
        { name: 'totalEvidence', label: 'Total Evidence', type: 'number', dataSource: 'statistics.totalEvidence' },
        { name: 'byType', label: 'By Type', type: 'chart', chartType: 'pie', dataSource: 'statistics.evidenceByType' },
        { name: 'byDomain', label: 'By Domain', type: 'chart', chartType: 'bar', dataSource: 'statistics.evidenceByDomain' }
      ]
    },
    {
      id: 'timeline',
      name: 'Timeline',
      required: false,
      conditional: true,
      conditionDataSource: 'timeline',
      conditionOperator: 'exists',
      fields: [
        { name: 'events', label: 'Timeline Events', type: 'timeline', dataSource: 'timeline' }
      ]
    },
    {
      id: 'osintData',
      name: 'OSINT Intelligence',
      required: false,
      conditional: true,
      conditionDataSource: 'osint',
      conditionOperator: 'exists',
      fields: [
        { name: 'searches', label: 'Searches', type: 'list', dataSource: 'osint.searches' },
        { name: 'findings', label: 'Findings', type: 'list', dataSource: 'osint.findings' }
      ]
    },
    {
      id: 'recommendations',
      name: 'Recommendations',
      required: false,
      conditional: false,
      fields: [
        { name: 'recommendations', label: 'Recommendations', type: 'list' }
      ]
    },
    {
      id: 'chainOfCustody',
      name: 'Chain of Custody',
      required: true,
      conditional: true,
      conditionDataSource: 'custody',
      conditionOperator: 'exists',
      fields: [
        { name: 'records', label: 'Custody Records', type: 'table', dataSource: 'custody' }
      ]
    },
    {
      id: 'appendix',
      name: 'Appendix',
      required: false,
      conditional: false,
      fields: [
        { name: 'additionalData', label: 'Additional Data', type: 'textarea' }
      ]
    }
  ],

  styling: {
    primaryColor: '#2c3e50',
    secondaryColor: '#3498db',
    fontFamily: 'Segoe UI, sans-serif',
    fontSize: 11,
    pageMargins: { top: 20, right: 20, bottom: 20, left: 20 }
  }
};

/**
 * Executive Briefing Template
 */
const ExecutiveBriefingTemplate = {
  id: 'executive-briefing',
  name: 'Executive Briefing',
  description: 'High-level executive summary report',
  version: '1.0.0',
  category: 'executive',

  sections: [
    {
      id: 'coverPage',
      name: 'Cover Page',
      required: true,
      conditional: false
    },
    {
      id: 'executiveSummary',
      name: 'Executive Summary',
      required: true,
      conditional: false,
      fields: [
        { name: 'situation', label: 'Situation', type: 'textarea' },
        { name: 'background', label: 'Background', type: 'textarea' },
        { name: 'assessment', label: 'Assessment', type: 'textarea' }
      ]
    },
    {
      id: 'keyFindings',
      name: 'Key Findings',
      required: true,
      conditional: false,
      fields: [
        { name: 'findings', label: 'Key Findings', type: 'list', maxItems: 10 }
      ]
    },
    {
      id: 'impactAssessment',
      name: 'Impact Assessment',
      required: true,
      conditional: false,
      fields: [
        { name: 'severity', label: 'Severity', type: 'select', options: ['Low', 'Medium', 'High', 'Critical'] },
        { name: 'scope', label: 'Scope', type: 'textarea' },
        { name: 'impact', label: 'Potential Impact', type: 'textarea' }
      ]
    },
    {
      id: 'recommendations',
      name: 'Recommendations',
      required: true,
      conditional: false,
      fields: [
        { name: 'immediate', label: 'Immediate Actions', type: 'list' },
        { name: 'shortTerm', label: 'Short-term Actions', type: 'list' },
        { name: 'longTerm', label: 'Long-term Actions', type: 'list' }
      ]
    },
    {
      id: 'conclusion',
      name: 'Conclusion',
      required: true,
      conditional: false,
      fields: [
        { name: 'summary', label: 'Summary', type: 'textarea' }
      ]
    }
  ],

  styling: {
    primaryColor: '#34495e',
    secondaryColor: '#e74c3c',
    fontFamily: 'Arial, sans-serif',
    fontSize: 12,
    pageMargins: { top: 25, right: 25, bottom: 25, left: 25 }
  }
};

/**
 * Technical Analysis Template
 */
const TechnicalAnalysisTemplate = {
  id: 'technical-analysis',
  name: 'Technical Analysis Report',
  description: 'Detailed technical investigation report',
  version: '1.0.0',
  category: 'technical',

  sections: [
    {
      id: 'coverPage',
      name: 'Cover Page',
      required: true,
      conditional: false
    },
    {
      id: 'tableOfContents',
      name: 'Table of Contents',
      required: true,
      conditional: false,
      autoGenerate: true
    },
    {
      id: 'introduction',
      name: 'Introduction',
      required: true,
      conditional: false,
      fields: [
        { name: 'background', label: 'Background', type: 'textarea' },
        { name: 'objectives', label: 'Objectives', type: 'list' },
        { name: 'scope', label: 'Scope', type: 'textarea' }
      ]
    },
    {
      id: 'methodology',
      name: 'Methodology',
      required: true,
      conditional: false,
      fields: [
        { name: 'approach', label: 'Approach', type: 'textarea' },
        { name: 'tools', label: 'Tools Used', type: 'list' },
        { name: 'procedures', label: 'Procedures', type: 'textarea' }
      ]
    },
    {
      id: 'technicalFindings',
      name: 'Technical Findings',
      required: true,
      conditional: false,
      fields: [
        { name: 'findings', label: 'Findings', type: 'list' },
        { name: 'analysis', label: 'Analysis', type: 'textarea' }
      ]
    },
    {
      id: 'networkAnalysis',
      name: 'Network Analysis',
      required: false,
      conditional: true,
      conditionDataSource: 'networkData',
      conditionOperator: 'exists',
      fields: [
        { name: 'traffic', label: 'Network Traffic', type: 'table' },
        { name: 'domains', label: 'Domains Contacted', type: 'list' },
        { name: 'ips', label: 'IP Addresses', type: 'list' }
      ]
    },
    {
      id: 'osintData',
      name: 'OSINT Data',
      required: true,
      conditional: true,
      conditionDataSource: 'osint',
      conditionOperator: 'exists',
      fields: [
        { name: 'sources', label: 'Data Sources', type: 'list' },
        { name: 'findings', label: 'OSINT Findings', type: 'list' },
        { name: 'correlations', label: 'Correlations', type: 'list' }
      ]
    },
    {
      id: 'evidenceDetails',
      name: 'Evidence Details',
      required: true,
      conditional: true,
      conditionDataSource: 'evidence',
      conditionOperator: 'exists',
      fields: [
        { name: 'evidenceList', label: 'Evidence Items', type: 'table', dataSource: 'evidence' }
      ]
    },
    {
      id: 'chainOfCustody',
      name: 'Chain of Custody',
      required: true,
      conditional: false,
      fields: [
        { name: 'records', label: 'Custody Records', type: 'table', dataSource: 'custody' }
      ]
    },
    {
      id: 'conclusion',
      name: 'Conclusion',
      required: true,
      conditional: false,
      fields: [
        { name: 'summary', label: 'Summary', type: 'textarea' },
        { name: 'recommendations', label: 'Recommendations', type: 'list' }
      ]
    }
  ],

  styling: {
    primaryColor: '#2c3e50',
    secondaryColor: '#16a085',
    fontFamily: 'Courier New, monospace',
    fontSize: 10,
    pageMargins: { top: 15, right: 15, bottom: 15, left: 15 }
  }
};

/**
 * Evidence Documentation Template
 */
const EvidenceDocumentationTemplate = {
  id: 'evidence-documentation',
  name: 'Evidence Documentation',
  description: 'Comprehensive evidence catalog and documentation',
  version: '1.0.0',
  category: 'evidence',

  sections: [
    {
      id: 'coverPage',
      name: 'Cover Page',
      required: true,
      conditional: false
    },
    {
      id: 'tableOfContents',
      name: 'Table of Contents',
      required: true,
      conditional: false,
      autoGenerate: true
    },
    {
      id: 'evidenceList',
      name: 'Evidence List',
      required: true,
      conditional: false,
      fields: [
        { name: 'items', label: 'Evidence Items', type: 'table', dataSource: 'evidence',
          columns: ['exhibitNumber', 'type', 'captureTime', 'hash']
        }
      ]
    },
    {
      id: 'evidenceDetails',
      name: 'Evidence Details',
      required: true,
      conditional: false,
      fields: [
        { name: 'details', label: 'Detailed Evidence Information', type: 'list', dataSource: 'evidence' }
      ]
    },
    {
      id: 'screenshots',
      name: 'Screenshots',
      required: false,
      conditional: true,
      conditionDataSource: 'evidence',
      conditionOperator: 'hasType',
      conditionValue: 'screenshot',
      fields: [
        { name: 'images', label: 'Screenshot Evidence', type: 'gallery', dataSource: 'evidence.screenshots' }
      ]
    },
    {
      id: 'integrity',
      name: 'Evidence Integrity',
      required: true,
      conditional: false,
      fields: [
        { name: 'hashes', label: 'Integrity Hashes', type: 'table',
          columns: ['evidenceId', 'algorithm', 'hash']
        },
        { name: 'verification', label: 'Verification Procedures', type: 'textarea' }
      ]
    },
    {
      id: 'chainOfCustody',
      name: 'Chain of Custody',
      required: true,
      conditional: false,
      fields: [
        { name: 'records', label: 'Custody Records', type: 'table', dataSource: 'custody',
          columns: ['timestamp', 'action', 'userID', 'notes']
        }
      ]
    },
    {
      id: 'certifications',
      name: 'Certifications',
      required: false,
      conditional: false,
      fields: [
        { name: 'examinerCertification', label: 'Examiner Certification', type: 'textarea' },
        { name: 'signature', label: 'Digital Signature', type: 'text' }
      ]
    }
  ],

  styling: {
    primaryColor: '#2c3e50',
    secondaryColor: '#27ae60',
    fontFamily: 'Times New Roman, serif',
    fontSize: 11,
    pageMargins: { top: 25, right: 25, bottom: 25, left: 25 }
  }
};

// =============================================================================
// TemplateManager Class
// =============================================================================

/**
 * TemplateManager - Manage report templates
 */
class TemplateManager {
  constructor(options = {}) {
    this.config = {
      logger: options.logger || null
    };

    this.templates = new Map();
    this.customTemplates = new Map();

    // Load built-in templates
    this._loadBuiltInTemplates();
  }

  /**
   * Load built-in templates
   * @private
   */
  _loadBuiltInTemplates() {
    this.templates.set('investigation-report', InvestigationReportTemplate);
    this.templates.set('executive-briefing', ExecutiveBriefingTemplate);
    this.templates.set('technical-analysis', TechnicalAnalysisTemplate);
    this.templates.set('evidence-documentation', EvidenceDocumentationTemplate);
  }

  /**
   * Get template by ID
   * @param {string} templateId - Template ID
   * @returns {Object|null} Template
   */
  getTemplate(templateId) {
    return this.templates.get(templateId) || this.customTemplates.get(templateId) || null;
  }

  /**
   * List all templates
   * @param {Object} options - List options
   * @param {string} options.category - Filter by category
   * @returns {Array} Templates
   */
  listTemplates(options = {}) {
    const allTemplates = [
      ...Array.from(this.templates.values()),
      ...Array.from(this.customTemplates.values())
    ];

    if (options.category) {
      return allTemplates.filter(t => t.category === options.category);
    }

    return allTemplates;
  }

  /**
   * Create custom template
   * @param {Object} template - Template definition
   * @returns {Object} Result
   */
  async createTemplate(template) {
    const templateId = template.id || this._generateTemplateId();

    // Validate template
    const validation = this._validateTemplate(template);
    if (!validation.valid) {
      return {
        success: false,
        errors: validation.errors,
        timestamp: Date.now()
      };
    }

    // Add to custom templates
    const fullTemplate = {
      ...template,
      id: templateId,
      version: template.version || '1.0.0',
      createdAt: Date.now(),
      custom: true
    };

    this.customTemplates.set(templateId, fullTemplate);

    // Save to storage
    await this._saveCustomTemplate(fullTemplate);

    return {
      success: true,
      templateId,
      timestamp: Date.now()
    };
  }

  /**
   * Update custom template
   * @param {string} templateId - Template ID
   * @param {Object} updates - Template updates
   * @returns {Object} Result
   */
  async updateTemplate(templateId, updates) {
    const template = this.customTemplates.get(templateId);

    if (!template) {
      return {
        success: false,
        error: 'Template not found or is not custom',
        timestamp: Date.now()
      };
    }

    const updated = {
      ...template,
      ...updates,
      updatedAt: Date.now()
    };

    // Validate updated template
    const validation = this._validateTemplate(updated);
    if (!validation.valid) {
      return {
        success: false,
        errors: validation.errors,
        timestamp: Date.now()
      };
    }

    this.customTemplates.set(templateId, updated);
    await this._saveCustomTemplate(updated);

    return {
      success: true,
      templateId,
      timestamp: Date.now()
    };
  }

  /**
   * Delete custom template
   * @param {string} templateId - Template ID
   * @returns {Object} Result
   */
  async deleteTemplate(templateId) {
    if (!this.customTemplates.has(templateId)) {
      return {
        success: false,
        error: 'Template not found or is not custom',
        timestamp: Date.now()
      };
    }

    this.customTemplates.delete(templateId);
    await this._deleteCustomTemplate(templateId);

    return {
      success: true,
      templateId,
      timestamp: Date.now()
    };
  }

  /**
   * Validate template
   * @private
   */
  _validateTemplate(template) {
    const errors = [];

    if (!template.name) {
      errors.push({ field: 'name', error: 'Name is required' });
    }

    if (!template.sections || !Array.isArray(template.sections)) {
      errors.push({ field: 'sections', error: 'Sections must be an array' });
    }

    if (template.sections) {
      template.sections.forEach((section, index) => {
        if (!section.id) {
          errors.push({ field: `sections[${index}].id`, error: 'Section ID is required' });
        }
        if (!section.name) {
          errors.push({ field: `sections[${index}].name`, error: 'Section name is required' });
        }
      });
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }

  /**
   * Generate template ID
   * @private
   */
  _generateTemplateId() {
    return `custom_template_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
  }

  /**
   * Save custom template
   * @private
   */
  async _saveCustomTemplate(template) {
    const storage = this._getStorage();
    const key = `report_template_${template.id}`;
    await storage.set({ [key]: template });
  }

  /**
   * Delete custom template
   * @private
   */
  async _deleteCustomTemplate(templateId) {
    const storage = this._getStorage();
    const key = `report_template_${templateId}`;
    await storage.remove(key);
  }

  /**
   * Get storage API
   * @private
   */
  _getStorage() {
    if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local) {
      return chrome.storage.local;
    }
    return this._getMockStorage();
  }

  /**
   * Get mock storage
   * @private
   */
  _getMockStorage() {
    if (!this._mockStore) {
      this._mockStore = {};
    }
    return {
      get: (keys) => {
        return new Promise((resolve) => {
          if (Array.isArray(keys)) {
            const result = {};
            keys.forEach(k => {
              if (this._mockStore[k] !== undefined) result[k] = this._mockStore[k];
            });
            resolve(result);
          } else if (typeof keys === 'string') {
            resolve({ [keys]: this._mockStore[keys] });
          } else {
            resolve({ ...this._mockStore });
          }
        });
      },
      set: (items) => {
        return new Promise((resolve) => {
          Object.assign(this._mockStore, items);
          resolve();
        });
      },
      remove: (keys) => {
        return new Promise((resolve) => {
          const keyList = Array.isArray(keys) ? keys : [keys];
          keyList.forEach(k => delete this._mockStore[k]);
          resolve();
        });
      }
    };
  }
}

// =============================================================================
// Exports
// =============================================================================

if (typeof globalThis !== 'undefined') {
  globalThis.InvestigationReportTemplate = InvestigationReportTemplate;
  globalThis.ExecutiveBriefingTemplate = ExecutiveBriefingTemplate;
  globalThis.TechnicalAnalysisTemplate = TechnicalAnalysisTemplate;
  globalThis.EvidenceDocumentationTemplate = EvidenceDocumentationTemplate;
  globalThis.TemplateManager = TemplateManager;
}

if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    InvestigationReportTemplate,
    ExecutiveBriefingTemplate,
    TechnicalAnalysisTemplate,
    EvidenceDocumentationTemplate,
    TemplateManager
  };
}
